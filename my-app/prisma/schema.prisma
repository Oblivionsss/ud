datasource db {
  provider = "sqlite" // Or your chosen database provider
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id               String           @id @default(cuid())
  username         String?          @unique
  email            String?          @unique
  name             String?
  image            String?
  handle           String?
  isAdmin          Boolean          @default(false)
  isServiceAdmin   Boolean          @default(false)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  Project          Project[]
  Document         Document[]
  ServiceRequest   ServiceRequest[]
  ApprovedRequests ServiceRequest[] @relation("ApprovedRequests")
  roles            UserRole[]
}

model Project {
  id             String           @id @default(cuid())
  name           String
  description    String?
  status         String           @default("ACTIVE")
  ownerId        String
  owner          User             @relation(fields: [ownerId], references: [id])
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  Document       Document[]
  ServiceRequest ServiceRequest[]
}

model Document {
  id         String   @id @default(cuid())
  name       String
  fileUrl    String
  projectId  String
  project    Project  @relation(fields: [projectId], references: [id])
  uploadedBy String
  uploader   User     @relation(fields: [uploadedBy], references: [id])
  createdAt  DateTime @default(now())
}

model ServiceRequest {
  id              String   @id @default(cuid())
  title           String
  description     String?
  contractorName  String
  contractorEmail String
  contractorPhone String?
  projectId       String
  project         Project  @relation(fields: [projectId], references: [id])
  requestedBy     String
  requester       User     @relation(fields: [requestedBy], references: [id])
  status          String   @default("PENDING") // PENDING, APPROVED, REJECTED
  approvedBy      String?
  approver        User?    @relation("ApprovedRequests", fields: [approvedBy], references: [id])
  rejectionReason String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  serviceId       String?
  service         Service? @relation(fields: [serviceId], references: [id])
}

model BusinessProcess {
  id                   String                 @id @default(cuid())
  name                 String
  description          String?
  order                Int                    @default(0)
  isDefault            Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  ProcessSchemaElement ProcessSchemaElement[]
}

// Business Process Templates - шаблоны бизнес-процессов с реквизитами

model BusinessProcessTemplate {
  id          String                             @id @default(cuid())
  name        String
  description String?
  isActive    Boolean                            @default(true)
  order       Int                                @default(0)
  createdAt   DateTime                           @default(now())
  updatedAt   DateTime                           @updatedAt
  requisites  BusinessProcessTemplateRequisite[]
}

model BusinessProcessTemplateRequisite {
  id          String                  @id @default(cuid())
  templateId  String
  template    BusinessProcessTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name        String
  label       String
  fieldType   String // text, email, phone, date, number, select, textarea, file, approval
  isRequired  Boolean                 @default(false)
  placeholder String?
  options     String? // JSON string for select options
  validation  String? // JSON string for validation rules
  order       Int                     @default(0)
  createdAt   DateTime                @default(now())
  updatedAt   DateTime                @updatedAt
}

model ServiceCategory {
  id          String            @id @default(cuid())
  name        String
  description String?
  parentId    String?
  parent      ServiceCategory?  @relation("ServiceCategoryHierarchy", fields: [parentId], references: [id])
  children    ServiceCategory[] @relation("ServiceCategoryHierarchy")
  services    Service[]
  order       Int               @default(0)
  isActive    Boolean           @default(true)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
}

model Service {
  id             String           @id @default(cuid())
  name           String
  description    String?
  categoryId     String
  category       ServiceCategory  @relation(fields: [categoryId], references: [id])
  isActive       Boolean          @default(true)
  version        Int              @default(1)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  ServiceRequest ServiceRequest[]
  ProcessSchema  ProcessSchema[]
}

model ProcessSchema {
  id               String                 @id @default(cuid())
  name             String
  description      String?
  serviceId        String?
  service          Service?               @relation(fields: [serviceId], references: [id])
  isTemplate       Boolean                @default(false)
  isPublished      Boolean                @default(false)
  version          Int                    @default(1)
  versionLabel     String? // optional human-friendly label for this version
  isActive         Boolean                @default(true)
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt
  elements         ProcessSchemaElement[]
  connections      ProcessConnection[]
  applications     ServiceApplication[]
  DocumentationSet DocumentationSet[]
}

model ProcessSchemaElement {
  id                   String                 @id @default(cuid())
  schemaId             String
  schema               ProcessSchema          @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  elementType          String // START, END, PROCESS, DECISION, DOCUMENT, APPROVAL
  name                 String
  description          String?
  businessProcessId    String?
  businessProcess      BusinessProcess?       @relation(fields: [businessProcessId], references: [id])
  positionX            Float                  @default(0)
  positionY            Float                  @default(0)
  width                Float                  @default(120)
  height               Float                  @default(60)
  properties           String? // JSON string for additional properties
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt
  sourceConnections    ProcessConnection[]    @relation("SourceElement")
  targetConnections    ProcessConnection[]    @relation("TargetElement")
  // Process components
  requisites           ProcessRequisite[]
  checklists           ProcessChecklist[]
  roles                ProcessRole[]
  transitions          ProcessTransition[]
  notifications        ProcessNotification[]
  DocumentationSet     DocumentationSet[]
  DocumentationSetItem DocumentationSetItem[]
}

model ProcessConnection {
  id             String               @id @default(cuid())
  schemaId       String
  schema         ProcessSchema        @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  sourceId       String
  source         ProcessSchemaElement @relation("SourceElement", fields: [sourceId], references: [id], onDelete: Cascade)
  targetId       String
  target         ProcessSchemaElement @relation("TargetElement", fields: [targetId], references: [id], onDelete: Cascade)
  connectionType String               @default("sequence") // sequence, conditional, parallel
  condition      String? // For conditional connections
  label          String?
  points         String? // JSON string for connection path points
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

// Process component models

model ProcessRequisite {
  id             String               @id @default(cuid())
  elementId      String
  element        ProcessSchemaElement @relation(fields: [elementId], references: [id], onDelete: Cascade)
  name           String
  label          String
  fieldType      String // text, email, phone, date, number, select, textarea, file, approval
  isRequired     Boolean              @default(false)
  placeholder    String?
  options        String? // JSON string for select options
  allowMultiple  Boolean              @default(false) // for select-type requisites
  validation     String? // JSON string for validation rules
  order          Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  // Approval stages for approval type requisites
  approvalStages ApprovalStage[]
}

model ProcessChecklist {
  id             String               @id @default(cuid())
  elementId      String
  element        ProcessSchemaElement @relation(fields: [elementId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isRequired     Boolean              @default(true)
  fileTypes      String? // JSON array of allowed file types
  maxFileSize    Int? // in MB
  allowDocuments Boolean              @default(true) // Allow document uploads
  allowComments  Boolean              @default(true) // Allow comments
  order          Int                  @default(0)
  // Meta: JSON string to store inheritance info { inherited: boolean, inheritedFromElementId, inheritedFromElementName }
  meta           String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model ProcessRole {
  id          String               @id @default(cuid())
  elementId   String
  element     ProcessSchemaElement @relation(fields: [elementId], references: [id], onDelete: Cascade)
  name        String
  roleType    String // initiатор, executor, approver, observer
  description String?
  isRequired  Boolean              @default(true)
  canEdit     Boolean              @default(false)
  canApprove  Boolean              @default(false)
  canReject   Boolean              @default(false)
  canRegister Boolean              @default(false)
  order       Int                  @default(0)
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt
}

model ProcessTransition {
  id             String               @id @default(cuid())
  elementId      String
  element        ProcessSchemaElement @relation(fields: [elementId], references: [id], onDelete: Cascade)
  name           String
  condition      String // approved, rejected, timeout, custom
  targetState    String?
  description    String?
  transitionType String               @default("next") // next, approve_or_reject, send_for_review, send_for_approval, assign_executor, resolution
  isDefault      Boolean              @default(false)
  order          Int                  @default(0)
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
}

model ProcessNotification {
  id         String               @id @default(cuid())
  elementId  String
  element    ProcessSchemaElement @relation(fields: [elementId], references: [id], onDelete: Cascade)
  name       String
  trigger    String // on_enter, on_exit, on_approve, on_reject, on_timeout
  template   String // email template with variables
  recipients String // JSON array of role types or specific users
  isActive   Boolean              @default(true)
  order      Int                  @default(0)
  createdAt  DateTime             @default(now())
  updatedAt  DateTime             @updatedAt
}

// Reusable role templates for quick setup across schemas

model RoleTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  roleType    String
  canEdit     Boolean  @default(false)
  canApprove  Boolean  @default(false)
  canRegister Boolean  @default(false)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Approval stages for approval requisites

model ApprovalStage {
  id            String           @id @default(cuid())
  requisiteId   String
  requisite     ProcessRequisite @relation(fields: [requisiteId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  order         Int              @default(0)
  isRequired    Boolean          @default(true)
  approverRole  String? // Role type that can approve this stage
  // New fields for enhanced approval process
  department    String? // Department responsible for this stage
  executionType String           @default("sequential") // sequential, parallel
  deadlineDays  Int? // Deadline in days
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

// Service Applications - заявки пользователей по схемам процессов

model ServiceApplication {
  id           String        @id @default(cuid())
  title        String
  description  String?
  schemaId     String
  schema       ProcessSchema @relation(fields: [schemaId], references: [id])
  applicantId  String
  status       String        @default("DRAFT") // DRAFT, SUBMITTED, IN_PROGRESS, COMPLETED, REJECTED
  formData     String? // JSON with form field values
  currentStage String? // Current process stage
  assignedTo   String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
}

// Reusable transition templates for process transitions

model TransitionTemplate {
  id             String   @id @default(cuid())
  name           String
  description    String?
  condition      String
  targetState    String?
  transitionType String   @default("next") // next, approve_or_reject, send_for_review, send_for_approval, assign_executor, resolution
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([name])
}

// Requisite templates for reusable field presets

model RequisiteTemplate {
  id            String   @id @default(cuid())
  name          String
  label         String
  fieldType     String
  isRequired    Boolean  @default(false)
  placeholder   String?
  options       String?
  allowMultiple Boolean  @default(false)
  validation    String?
  order         Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([name])
}

// Decision templates (e.g., "Типовое Решение")

model DecisionTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  config      String // JSON string describing decision config: branches, strictness, roleType, etc.
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
}

// Library of print form templates for reuse across processes

model PrintFormTemplate {
  id           String   @id @default(cuid())
  label        String
  templateUrl  String
  templateName String
  mappings     String? // JSON array of { token, requisiteName }
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([label])
}

// Checklist templates library

model ChecklistTemplate {
  id             String                  @id @default(cuid())
  label          String
  description    String?
  isRequired     Boolean                 @default(true)
  allowDocuments Boolean                 @default(true)
  allowComments  Boolean                 @default(true)
  fileTypes      String? // JSON array of allowed file types
  maxFileSize    Int?
  order          Int                     @default(0)
  isActive       Boolean                 @default(true)
  createdAt      DateTime                @default(now())
  updatedAt      DateTime                @updatedAt
  items          ChecklistTemplateItem[]

  @@index([label])
}

model ChecklistTemplateItem {
  id             String            @id @default(cuid())
  templateId     String
  template       ChecklistTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  name           String
  description    String?
  isRequired     Boolean           @default(true)
  allowDocuments Boolean           @default(true)
  allowComments  Boolean           @default(true)
  fileTypes      String?
  maxFileSize    Int?
  order          Int               @default(0)
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
}

// Notification templates library
// Global user roles for filtering assignees and presets

model UserRole {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  roleType  String // applicant, executor, approver
  createdAt DateTime @default(now())

  @@unique([userId, roleType])
  @@index([roleType])
}

model NotificationTemplate {
  id         String   @id @default(cuid())
  name       String
  trigger    String // on_enter, on_exit, on_approve, on_reject, on_timeout
  template   String // email template body
  recipients String // JSON array of role types or user ids
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([name])
}

// Dictionary of available role types for processes and templates

model RoleType {
  id        String   @id @default(cuid())
  code      String   @unique // e.g. applicant, executor, approver, observer
  name      String // Human-readable label
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
}

model DocumentationSet {
  id                String                 @id @default(cuid())
  schemaId          String
  schema            ProcessSchema          @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  decisionElementId String
  decisionElement   ProcessSchemaElement   @relation(fields: [decisionElementId], references: [id], onDelete: Cascade)
  name              String
  createdAt         DateTime               @default(now())
  updatedAt         DateTime               @updatedAt
  items             DocumentationSetItem[]

  @@index([schemaId])
  @@index([decisionElementId])
}

model DocumentationSetItem {
  id              String               @id @default(cuid())
  setId           String
  set             DocumentationSet     @relation(fields: [setId], references: [id], onDelete: Cascade)
  itemType        String // requisite | checklist
  sourceElementId String
  sourceElement   ProcessSchemaElement @relation(fields: [sourceElementId], references: [id])
  sourceId        String // id of ProcessRequisite or ProcessChecklist
  label           String
  order           Int                  @default(0)
  createdAt       DateTime             @default(now())

  @@index([setId])
  @@index([sourceElementId])
}